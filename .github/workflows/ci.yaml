name: CI

on:
    push:
        branches: [ main ]
    pull_request:

jobs:
    tests:
        runs-on: 'ubuntu-latest'
        name: "Test ${{ matrix.php }}"
        strategy:
            fail-fast: true
            matrix:
                php: [ '7.4' ]
                include:
                    - php: '8.0'
                      skip_cs: 'true'
                    - php: '8.1'
                      skip_cs: 'true'

        steps:
            -   name: 'Check out repository code'
                uses: actions/checkout@v2

            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: ${{ matrix.php }}
                    tools: composer
                    coverage: pcov

            -   name: Install Composer dependencies
                uses: ramsey/composer-install@v2

            -   name: Install CoversValidator Composer dependencies
                uses: ramsey/composer-install@v2
                with:
                    working-directory: 'vendor-bin/covers-validator'

            -   name: Install PHP-CS-Fixer Composer dependencies
                uses: ramsey/composer-install@v2
                with:
                    working-directory: 'vendor-bin/php-cs-fixer'

            -   name: Install Psalm Composer dependencies
                uses: ramsey/composer-install@v2
                with:
                    working-directory: 'vendor-bin/psalm'

            -   name: Mark skip CS
                if: matrix.skip_cs == 'true'
                run: echo "SKIP_CS=1" >> $GITHUB_ENV

            - name: 'debug2'
              run: echo "start- $SKIP_CS -end"

            -   name: 'Run tests'
                run: make
